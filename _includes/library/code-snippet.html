{% assign snippet_lang = include.lang | default: "text" %}
{% assign snippet_title = include.title | default: "" %}
{% assign snippet_code = include.code | default: "" %}

<section class="code-snippet-card js-code-snippet">
  <header class="code-snippet-header">
    <span class="code-snippet-title">{% if snippet_title != "" %}{{ snippet_title }}{% else %}Code snippet{% endif %}</span>
    <span class="code-snippet-tools">
      <span class="code-snippet-lang">{{ snippet_lang }}</span>
      <button class="code-snippet-copy" type="button" aria-label="Copy code">Copy</button>
    </span>
  </header>
  <pre class="code-snippet-pre"><code class="language-{{ snippet_lang }}" data-lang="{{ snippet_lang }}">{{ snippet_code | strip | escape }}</code></pre>
</section>

<script>
  (function () {
    if (window.__codeSnippetLibInit) return;
    window.__codeSnippetLibInit = true;

    function escapeHtml(text) {
      return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function highlightPython(raw) {
      var tokenRegex = /(#.*$)|("""[\s\S]*?"""|'''[\s\S]*?'''|"(?:\\.|[^"\\])*"|'(?:\\.|[^'\\])*')|\b(import|from|as|def|class|for|while|if|elif|else|try|except|finally|return|with|in|is|and|or|not|None|True|False|lambda|pass|break|continue|yield|raise|global|nonlocal|assert|del)\b|\b(print|len|range|list|dict|set|tuple|int|float|str|bool|enumerate|zip|map|filter|sum|min|max)\b|\b(\d+(?:\.\d+)?)\b|(@[A-Za-z_][A-Za-z0-9_]*)/gm;
      var out = '';
      var last = 0;
      var match;

      while ((match = tokenRegex.exec(raw)) !== null) {
        out += escapeHtml(raw.slice(last, match.index));
        var cls = 'py-text';
        if (match[1]) cls = 'py-comment';
        else if (match[2]) cls = 'py-string';
        else if (match[3]) cls = 'py-keyword';
        else if (match[4]) cls = 'py-builtin';
        else if (match[5]) cls = 'py-number';
        else if (match[6]) cls = 'py-decorator';
        out += '<span class="' + cls + '">' + escapeHtml(match[0]) + '</span>';
        last = tokenRegex.lastIndex;
      }
      out += escapeHtml(raw.slice(last));
      return out;
    }

    function enhanceSnippets() {
      document.querySelectorAll('.js-code-snippet').forEach(function (card) {
        if (card.dataset.ready === 'true') return;
        card.dataset.ready = 'true';

        var code = card.querySelector('code');
        if (!code) return;

        var raw = code.textContent || '';
        var lang = (code.dataset.lang || '').toLowerCase();
        if (lang === 'python' || lang === 'py') {
          code.innerHTML = highlightPython(raw);
        } else {
          code.textContent = raw;
        }
      });
    }

    function copyToClipboard(text, onDone, onFail) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(onDone).catch(onFail);
        return;
      }

      var input = document.createElement('textarea');
      input.value = text;
      document.body.appendChild(input);
      input.select();
      try {
        document.execCommand('copy');
        onDone();
      } catch (e) {
        onFail();
      }
      document.body.removeChild(input);
    }

    document.addEventListener('click', function (event) {
      var button = event.target.closest('.code-snippet-copy');
      if (!button) return;
      var card = button.closest('.js-code-snippet');
      if (!card) return;
      var code = card.querySelector('code');
      if (!code) return;

      var original = button.textContent;
      copyToClipboard(code.textContent || '', function () {
        button.textContent = 'Copied';
        setTimeout(function () {
          button.textContent = original;
        }, 1200);
      }, function () {
        button.textContent = 'Failed';
        setTimeout(function () {
          button.textContent = original;
        }, 1200);
      });
    });

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', enhanceSnippets);
    } else {
      enhanceSnippets();
    }
  })();
</script>
